<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <meta name="description" content="SDK Muta - Kalkulator Tournament Scoring Application">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="apple-touch-icon" href="logo.png">
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <title>SDK Muta - Kalkulator</title>
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #333;
        }

        /* ===== NAVBAR ===== */
        .navbar {
            background: white;
            border-bottom: 1px solid #e1e5e9;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 10px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 20px;
        }

        .nav-logo-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 10px;
        }

        .nav-logo {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            background: white;
            border-radius: 8px;
        }

        .nav-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            display: none;
        }

        .nav-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .lang-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            cursor: pointer;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: #333;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .lang-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
            color: #007bff;
        }

        .lang-btn.active {
            background: #007bff;
            border-color: #0056b3;
            color: white;
        }

        .lang-btn.active:hover {
            background: #0056b3;
            color: white;
        }

        .help-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #666;
            cursor: pointer;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .help-btn:hover {
            background: #e9ecef;
            border-color: #007bff;
            color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .help-btn.active {
            background: #007bff;
            border-color: #0056b3;
            color: white;
        }

        .instructions-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #f5f9ff 100%);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .instructions-panel.active {
            display: block;
        }

        .instructions-panel h3 {
            color: #007bff;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .instructions-panel ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .instructions-panel li {
            margin: 0.5rem 0;
            color: #2c3e50;
            line-height: 1.6;
        }

        .instructions-panel strong {
            color: #007bff;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== MAIN CONTAINER ===== */
        .app-container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 0 15px;
        }

        /* ===== VIEWS ===== */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            font-weight: 700;
        }

        /* ===== SEARCH BOX ===== */
        .search-box {
            margin-bottom: 1rem;
        }

        .player-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem;
            font-size: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ===== PLAYERS LIST ===== */
        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .player-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            position: relative;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .player-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px);
        }

        .player-card.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .player-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .player-card.selected .player-checkbox {
            background-color: white;
            border-color: white;
        }

        .player-checkbox::after {
            content: '‚úì';
            color: #007bff;
            font-weight: bold;
            font-size: 1.2rem;
            display: none;
        }

        .player-card.selected .player-checkbox::after {
            display: block;
            color: #007bff;
        }

        .player-info {
            flex-grow: 1;
            min-width: 0;
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .player-card.selected .player-name {
            color: white;
        }

        .player-id {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .player-card.selected .player-id {
            color: rgba(255, 255, 255, 0.9);
        }

        .player-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-weight: 600;
        }

        .player-delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .player-card.selected .player-delete-btn {
            background: #ff6b6b;
        }

        .player-card.selected .player-delete-btn:hover {
            background: #fa5252;
        }

        /* ===== CONFIG SECTION ===== */
        .config-section {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .config-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .config-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .config-input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-width: 150px;
        }

        .input-field label {
            margin: 0;
            font-size: 0.95rem;
        }

        .input-field input {
            padding: 0.8rem;
            font-size: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .input-field input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ===== SUMMARY BOX ===== */
        .summary-box {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .summary-box h3 {
            color: #1976d2;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .summary-box p {
            font-size: 2rem;
            font-weight: 700;
            color: #1976d2;
        }

        /* ===== SCORING ===== */
        .scores-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .score-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .score-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            border-radius: 6px 6px 0 0;
        }

        .score-player-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
        }

        .targets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .target {
            background: var(--light-gray);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .target label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .target input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
            background: white;
            min-height: 3.2rem;
            line-height: 1.6;
        }

        .target input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Yellow highlight for 10s */
        .target input.value-ten {
            background-color: #ffd700;
            border-color: #ff8c00;
            color: #000;
            font-weight: 700;
            box-shadow: inset 0 0 0 2px #ff8c00;
        }

        .target input.value-ten:focus {
            border-color: #ff6600;
            box-shadow: inset 0 0 0 2px #ff6600, 0 0 0 3px rgba(255, 102, 0, 0.4);
        }

        .score-summary {
            background: rgba(90, 143, 209, 0.1);
            padding: 1rem;
            border-radius: 6px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .summary-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* ===== RESULTS ===== */
        .results-header {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 25px;
            text-align: center;
            flex-shrink: 0;
            color: white;
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        /* Dynamic header colors based on tournament type */
        .results-header.tournament-4_targets {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        .results-header.tournament-20_targets {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .results-header.tournament-40_targets {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .results-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
        }

        .results-header * {
            position: relative;
            z-index: 2;
        }

        .results-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: rgb(255, 255, 255);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .results-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .results-meta {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .meta-item {
            text-align: center;
        }

        .meta-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            display: block;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .meta-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .header-logo {
            height: 70px;
            max-width: 180px;
            object-fit: contain;
            margin-bottom: 15px;
            filter: brightness(1.2) contrast(1.1);
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .results-table-container {
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }


        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #f1f3f4;
            border-right: 1px solid #f1f3f4;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table th.rank-col {
            width: 80px;
        }

        .results-table th.player-col {
            text-align: left;
            width: auto;
        }

        .results-table th.score-col {
            width: 100px;
            background: #e3f2fd;
        }

        .results-table th.tens-col {
            width: 100px;
            background: #fff3cd;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .results-table tbody tr:nth-child(1) {
            background: #fff9e6;
        }

        .results-table tbody tr:nth-child(1):hover {
            background: #fff3cd;
        }

        .results-table tbody tr:nth-child(2) {
            background: #f5f5f5;
        }

        .results-table tbody tr:nth-child(2):hover {
            background: #e9ecef;
        }

        .results-table tbody tr:nth-child(3) {
            background: #fdf6f0;
        }

        .results-table tbody tr:nth-child(3):hover {
            background: #f8f1e6;
        }

        .rank-cell {
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
        }

        .rank-1 { color: #b8860b; }
        .rank-2 { color: #6c757d; }
        .rank-3 { color: #8b4513; }

        .player-cell {
            text-align: left !important;
            padding-left: 12px !important;
        }

        .player-name {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
        }

        .score-cell {
            background: #e3f2fd !important;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1976d2;
        }

        .tens-cell {
            background: #fff3cd !important;
            font-size: 1rem;
            font-weight: 700;
            color: #856404;
        }

        .position-badge {
            display: inline-block;
            width: 36px;
            height: 36px;
            line-height: 36px;
            text-align: center;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .position-badge.gold {
            background-color: #ffc107;
            color: #333;
        }

        .position-badge.silver {
            background-color: #c0c0c0;
            color: #333;
        }

        .position-badge.bronze {
            background-color: #cd7f32;
            color: white;
        }

        .player-score-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* ===== HISTORY ===== */
        .history-container {
            margin-bottom: 2rem;
        }

        .history-empty {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            color: #999;
            font-size: 1.1rem;
        }

        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .history-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .history-card:hover {
            border-color: #007bff;
            box-shadow: 0 8px 16px rgba(0, 123, 255, 0.3);
        }

        .history-card-date {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 0.5rem;
        }

        .history-card-config {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .history-card-winner {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .history-card-winner-name {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .history-card-winner-score {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .history-card-podium {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin: 1rem 0;
            background: linear-gradient(135deg, #f5f9ff 0%, #e3f2fd 100%);
            padding: 1rem;
            border-radius: 6px;
        }

        .podium-entry {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .podium-entry .medal {
            font-size: 1.2rem;
            min-width: 24px;
        }

        .podium-entry .name {
            flex: 1;
            color: #2c3e50;
            font-weight: 600;
        }

        .podium-entry .score {
            color: #666;
            font-size: 0.85rem;
        }

        .history-card-players {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }

        .history-card-delete {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .history-card-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* ===== BUTTONS ===== */
        .view-actions {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn {
            padding: 12px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            border: 2px solid #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background-color: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #007bff;
            color: #007bff;
            transform: translateY(-1px);
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
            border: 2px solid #ffc107;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #e0a800;
            transform: translateY(-1px);
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
            border: 2px solid #17a2b8;
        }

        .btn-info:hover {
            background-color: #138496;
            border-color: #138496;
            transform: translateY(-1px);
        }

        /* ===== COLLAPSIBLE SECTIONS ===== */
        .collapsible-header {
            background: none;
            border: none;
            padding: 0.8rem 0;
            margin: 0.8rem 0;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }

        .collapsible-header:hover {
            background-color: rgba(0, 123, 255, 0.05);
            border-radius: 8px;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .collapsible-icon {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 1.2rem;
            color: #007bff;
            min-width: 1.5rem;
        }

        .collapsible-header.collapsed .collapsible-icon {
            transform: rotate(-90deg);
        }

        .collapsible-counter {
            font-size: 0.9rem;
            color: #999;
            font-weight: normal;
            margin-left: auto;
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            opacity: 1;
            padding: 0 0 1rem 0;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            overflow: hidden;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .players-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .scores-container {
                grid-template-columns: 1fr;
            }

            .config-options {
                grid-template-columns: 1fr;
            }

            .view-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .view-actions > div:first-child {
                display: none;
            }

            .view-actions > div[style*="display: flex"] {
                flex-direction: column;
                width: 100%;
            }

            .view-actions > div[style*="display: flex"] > .btn {
                width: 100%;
            }

            .view h2 {
                display: none;
            }

            .nav-title {
                display: none;
            }

            .target {
                min-width: 70px;
            }

            .targets-grid {
                gap: 0.5rem;
            }

            #toggle-all-btn {
                padding: 0.8rem 0.6rem !important;
                font-size: 0.9rem;
            }

            .player-controls {
                gap: 0.5rem;
                align-items: flex-end;
            }

            .player-controls .search-box {
                margin-right: 0.5rem !important;
                margin-bottom: 0 !important;
                flex: 1;
            }

            #toggle-all-btn {
                width: 20% !important;
                padding: 0.8rem 0.4rem !important;
                flex-shrink: 0;
                justify-content: center;
            }

            .results-header {
                padding: 15px;
            }

            .results-title {
                font-size: 1.6rem;
            }

            .results-subtitle {
                font-size: 0.95rem;
            }

            .results-meta {
                gap: 10px;
            }

            .meta-number {
                font-size: 1.4rem;
            }

            .meta-label {
                font-size: 0.7rem;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
                font-size: 0.85rem;
            }

            .results-table th.score-col,
            .results-table th.tens-col {
                width: 80px;
            }

            .results-actions {
                flex-direction: column;
            }

            .results-actions .btn {
                width: 100%;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .navbar,
            .view-actions,
            .results-actions,
            .history-container,
            .instructions-panel {
                display: none !important;
            }

            html, body {
                margin: 0;
                padding: 0;
                background: white;
                color: black;
                height: auto;
                overflow: visible;
            }

            .app-container {
                background: white;
                padding: 0;
                margin: 0;
            }

            .view {
                display: none !important;
            }

            #view-results {
                display: block !important;
                background: white;
                padding: 20px;
                margin: 0;
            }

            .results-header {
                margin-bottom: 20px;
                page-break-inside: avoid;
                background: white !important;
                color: black !important;
                border: 1px solid #ddd;
            }

            .results-header::before {
                display: none !important;
            }

            .results-header * {
                color: black !important;
                text-shadow: none !important;
            }

            .header-logo {
                display: block !important;
                height: 60px;
                max-width: 160px;
                margin: 0 auto 15px;
                filter: none;
                background-color: transparent !important;
                border: none !important;
                padding: 0 !important;
            }

            .results-title {
                font-size: 28pt;
                margin-bottom: 10px;
                color: black !important;
            }

            .results-subtitle {
                font-size: 14pt;
                margin-bottom: 15px;
                color: #333 !important;
            }

            .results-meta {
                margin-bottom: 20px;
            }

            .meta-number {
                color: #000 !important;
            }

            .meta-label {
                color: #666 !important;
            }

            .results-table-container {
                background: white;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-top: 20px;
            }

            .results-table {
                border-collapse: collapse;
                width: 100%;
                font-size: 11pt;
            }

            .results-table th,
            .results-table td {
                border: 1px solid #999;
                padding: 8px;
                text-align: left;
            }

            .results-table th {
                background-color: #ddd;
                font-weight: bold;
                color: black;
            }

            .results-table tbody tr {
                background-color: white !important;
            }

            .results-table tbody tr:nth-child(even) td {
                background-color: #f5f5f5;
            }

            h2 {
                page-break-after: avoid;
                margin-top: 0;
                font-size: 20pt;
            }

            /* Prevent orphaned headers */
            h3 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo-title">
                <div class="nav-logo">
                    <img src="logo-header.svg" alt="SDK Muta Logo" style="width: 48px; height: 48px;">
                </div>
                <h1 class="nav-title" id="navbar-title">SDK Muta - Kalkulator</h1>
            </div>
            <div class="nav-right">
                <button class="help-btn" id="help-toggle-btn" onclick="toggleInstructions()" title="Show/Hide Instructions" style="display: none;">?</button>
                <button class="lang-btn" onclick="changeLanguage('en')">EN</button>
                <button class="lang-btn active" onclick="changeLanguage('sl')">SL</button>
            </div>
        </div>
    </nav>

    <!-- Main Application Container -->
    <div class="app-container">
        <!-- View 1: Participant Selection -->
        <div id="view-participants" class="view active">
            <div class="instructions-panel" id="instructions-participants">
                <h3>üìã <span data-i18n="instructions.title">Instructions</span></h3>
                <ol>
                    <li><span data-i18n="instructions.search">Search Players: Type a player name to find them quickly</span></li>
                    <li><span data-i18n="instructions.select_all">Select All: Click the ‚úì button to select/deselect all visible players</span></li>
                    <li><span data-i18n="instructions.select">Select Players: Click on player cards to select/deselect them</span></li>
                    <li><span data-i18n="instructions.add_new">Add New: Enter a name and click "Add" to add new players</span></li>
                    <li><span data-i18n="instructions.delete">Delete: Click the ‚úï button on a player card to remove them</span></li>
                    <li><span data-i18n="instructions.history">History: View your last 5 tournaments in the Tournament History section below</span></li>
                    <li><span data-i18n="instructions.continue">Continue: Once you've selected players, click "Start Match"</span></li>
                </ol>
            </div>

            <h2 data-i18n="players.player_management">Player Management</h2>

            <label style="font-weight: 600; color: #2c3e50; font-size: 0.95rem; display: block; margin-bottom: 0.5rem;" data-i18n="players.include_participant">Include a participant</label>
            <div class="player-controls">
                <div class="search-box" style="flex: 1; margin-bottom: 0; margin-right: 0.8rem;">
                    <input type="text"
                           id="player-search"
                           placeholder="Search players..."
                           data-i18n-placeholder="league.search_players_placeholder"
                           onkeyup="filterPlayers()">
                </div>
                <button class="btn btn-primary" id="toggle-all-btn" onclick="toggleAllPlayersButton()" title="Toggle select all" style="padding: 0.8rem 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">‚úì</button>
            </div>
            <div class="players-list" id="players-list"></div>

            <!-- Start Match Button -->
            <div style="margin-top: 1.5rem; display: flex; justify-content: center;">
                <button class="btn btn-danger" onclick="proceedToConfig()" style="background-color: #dc3545; border-color: #dc3545; color: #ffffff; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600;">
                    <span data-i18n="navigation.start_match">Start Match</span>
                </button>
            </div>

            <!-- Tournament History Section -->
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef;">
                <button class="collapsible-header collapsed" onclick="toggleCollapsible(this)">
                    <span class="collapsible-icon">‚ñº</span>
                    <h3 style="font-size: 1.4rem; margin: 0; color: #2c3e50; display: inline;" data-i18n="results.history_title">Tournament History</h3>
                    <span class="collapsible-counter" id="history-counter" style="font-size: 0.9rem; color: #999;">(0/5)</span>
                </button>
                <div class="collapsible-content collapsed" id="participants-history-container">
                    <div class="history-container">
                        <div class="history-empty" id="participants-history-empty">
                            <p data-i18n="results.no_history">No tournaments yet. Start a tournament to build history!</p>
                        </div>
                        <div class="history-list" id="participants-history-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 2: Tournament Configuration -->
        <div id="view-config" class="view">
            <h2 data-i18n="tournament.tournament_setup">Tournament Setup</h2>

            <div class="instructions-panel" id="instructions-config">
                <h3>üìã <span data-i18n="instructions.title">Instructions</span></h3>
                <ol>
                    <li><span data-i18n="instructions.targets">Number of Targets: How many targets will each player shoot at?</span></li>
                    <li><span data-i18n="instructions.bullets">Bullets per Target: How many bullets/shots per target?</span></li>
                    <li><span data-i18n="instructions.total">Total Shots: Automatically calculated (Targets √ó Bullets)</span></li>
                    <li><span data-i18n="instructions.example">Example: 20 targets √ó 2 bullets = 40 total shots</span></li>
                    <li><span data-i18n="instructions.config_continue">Continue: Click "Next" to start entering scores</span></li>
                </ol>
            </div>

            <div class="config-section">
                <div style="margin-bottom: 1.5rem;">
                    <div class="input-field">
                        <label style="font-weight: 600; color: #2c3e50; font-size: 0.95rem;" data-i18n="tournament.targets">Number of Targets:</label>
                        <input type="number"
                               id="targets-input"
                               value="20"
                               min="1"
                               max="100"
                               onchange="updateTotalShots()"
                               onkeyup="updateTotalShots()"
                               style="padding: 0.8rem; font-size: 1rem; border: 2px solid #e9ecef; border-radius: 8px; text-align: center; transition: all 0.2s ease; width: 100%;">
                    </div>
                </div>
                <div>
                    <div class="input-field">
                        <label style="font-weight: 600; color: #2c3e50; font-size: 0.95rem;" data-i18n="tournament.shots_per_target">Shots per Target:</label>
                        <input type="number"
                               id="bullets-per-target"
                               value="2"
                               min="1"
                               max="20"
                               onchange="updateTotalShots()"
                               onkeyup="updateTotalShots()"
                               style="padding: 0.8rem; font-size: 1rem; border: 2px solid #e9ecef; border-radius: 8px; text-align: center; transition: all 0.2s ease; width: 100%;">
                    </div>
                </div>
            </div>

            <div class="summary-box">
                <h3 data-i18n="results.total_shots">Total Shots:</h3>
                <p id="total-shots-display">40</p>
            </div>

            <div class="view-actions">
                <button class="btn btn-danger" onclick="proceedToScoring()" style="background-color: #dc3545; border-color: #dc3545; color: #ffffff;">
                    <span data-i18n="navigation.next">Next
                    </span>
                </button>
                <button class="btn btn-secondary" onclick="goToView('view-participants')">
                    <span data-i18n="navigation.back">Back</span>
                </button>
            </div>
        </div>

        <!-- View 3: Score Entry -->
        <div id="view-scoring" class="view">
            <h2 data-i18n="scoring.enter_scores">Enter Scores</h2>

            <div class="instructions-panel" id="instructions-scoring">
                <h3>üìã <span data-i18n="instructions.title">Instructions</span></h3>
                <ol>
                    <li><span data-i18n="instructions.range">Score Range: Enter scores from 0 to 10</span></li>
                    <li><span data-i18n="instructions.miss">0 = Miss: No points for that shot</span></li>
                    <li><span data-i18n="instructions.regular">1-9 = Regular: Points for partial hits</span></li>
                    <li><span data-i18n="instructions.perfect">10 = Perfect: Perfect shot (highlighted in YELLOW ‚ú®)</span></li>
                    <li><span data-i18n="instructions.auto_cap">Auto-Cap: Values over 10 automatically become 10</span></li>
                    <li><span data-i18n="instructions.real_time">Real-Time Updates: Totals update as you type</span></li>
                    <li><span data-i18n="instructions.auto_save">Auto-Save: All data saves automatically</span></li>
                    <li><span data-i18n="instructions.finish">Finish: Click "Finish Match" when all scores are entered</span></li>
                    <li><span data-i18n="instructions.excel_export">Excel Export: After finishing, download a detailed Excel report with all individual shot scores</span></li>
                </ol>
            </div>

            <div class="scores-container" id="scores-container"></div>

            <div class="view-actions">
                <button class="btn btn-danger" onclick="proceedToResults()" style="background-color: #dc3545; border-color: #dc3545; color: #ffffff;">
                    <span data-i18n="scoring.finish_tournament">Finish Match</span>
                </button>
                <button class="btn btn-secondary" onclick="goToView('view-config')">
                    <span data-i18n="navigation.back">Back</span>
                </button>
            </div>
        </div>

        <!-- View 4: Results Display -->
        <div id="view-results" class="view">
            <!-- Results Header -->
            <div class="results-header" id="results-header">
                <img src="logo.png" alt="Logo" class="header-logo" style="display: none;">
                <div class="results-title">
                    üèÜ <span data-i18n="results.final_results">Final Results</span>
                </div>
                <div class="results-subtitle" data-i18n="results.rankings">Complete Rankings</div>
                <div class="results-meta">
                    <div class="meta-item">
                        <span class="meta-number" id="header-participants">0</span>
                        <span class="meta-label" data-i18n="tournament.participants">Participants</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-number" id="header-configuration">
                            <span id="header-targets">0</span> T /
                            <span id="header-shots">0</span> S
                        </span>
                        <span class="meta-label" data-i18n="results.tournament_configuration">Tournament Config</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-number" id="header-highest-score">0</span>
                        <span class="meta-label" data-i18n="results.highest_score">Highest Score</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-number" id="header-most-tens">0</span>
                        <span class="meta-label" data-i18n="results.most_tens">Most 10s</span>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="results-table-container">
                <table class="results-table" id="results-table"></table>
            </div>

            <div class="results-actions">
                <button class="btn btn-info" onclick="downloadExcel()">
                    üìä <span data-i18n="results.export_excel">Download Excel</span>
                </button>
                <button class="btn btn-info" onclick="downloadJSON()">
                    üìÑ <span data-i18n="results.export_json">Download JSON</span>
                </button>
                <button class="btn btn-info" onclick="downloadPDF()">
                    üñ®Ô∏è <span data-i18n="results.export_pdf">Print/PDF</span>
                </button>
                <button class="btn btn-secondary" onclick="startNewTournament()">
                    <span data-i18n="navigation.back">Back to Start</span>
                </button>
            </div>
        </div>

        <!-- View 5: Tournament History -->
        <div id="view-history" class="view">
            <h2 data-i18n="results.history_title">Tournament History</h2>

            <div class="history-container" id="history-container">
                <div class="history-empty" id="history-empty">
                    <p data-i18n="results.no_history">No tournaments yet. Start a tournament to build history!</p>
                </div>
                <div class="history-list" id="history-list"></div>
            </div>

            <div class="view-actions">
                <div></div>
                <button class="btn btn-secondary" onclick="startNewTournament()">
                    <span data-i18n="navigation.back">Back to Start</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== TRANSLATION OBJECT =====
        const translations = {
            en: {
                "tournament.tournament": "Tournament",
                "players.player_management": "Player Management",
                "players.player": "Player",
                "players.name_placeholder": "Player name...",
                "league.search_players_placeholder": "Search players...",
                "league.no_players_selected": "Please select at least one player!",
                "general.next": "Next",
                "general.back": "Back",
                "navigation.back": "Back",
                "navigation.next": "Next",
                "navigation.start_match": "Start Match",
                "players.select_all": "‚úì All",
                "players.deselect_all": "‚úï None",
                "general.save": "Download Excel",
                "general.status": "Bullets per Target:",
                "tournament.targets": "Number of Targets:",
                "tournament.shots_per_target": "Shots per Target:",
                "general.new_tournament": "Start New Tournament",
                "tournament.tournament_setup": "Tournament Setup",
                "tournament_types.4_targets": "4 Targets",
                "tournament_types.4_targets_desc": "Quick format (5 shots each)",
                "tournament_types.20_targets": "20 Targets",
                "tournament_types.20_targets_desc": "Standard format (2 shots each)",
                "tournament_types.40_targets": "40 Targets",
                "tournament_types.40_targets_desc": "Extended format (2 shots each)",
                "tournament.participants": "Participants",
                "results.total_shots": "Total Shots",
                "results.final_results": "Final Results",
                "results.title": "Tournament Results",
                "results.date": "Date",
                "results.score": "Score",
                "results.position": "Position",
                "results.tens": "Tens",
                "results.total_score": "Total Score",
                "results.rankings": "Complete Rankings",
                "results.number_of_targets": "Number of Targets",
                "results.shots_per_target": "Shots per Target",
                "results.tournament_configuration": "Tournament Config",
                "results.highest_score": "Highest Score",
                "results.most_tens": "Most 10s",
                "results.export_excel": "Download Excel",
                "results.export_json": "Download JSON",
                "results.export_pdf": "Print/PDF",
                "results.view_history": "View History",
                "results.history_title": "Tournament History",
                "results.no_history": "No tournaments yet. Start a tournament to build history!",
                "results.targets": "targets",
                "results.shots": "shots",
                "results.points": "points",
                "results.pts": "pts",
                "results.players": "players",
                "scoring.enter_scores": "Enter Scores",
                "scoring.clear_all": "Clear All",
                "scoring.finish_tournament": "Finish Match",
                "scoring.target": "Target",
                "players.include_participant": "Include a participant",
                "players.add_new_player": "Add new player",
                "players.add_button": "Add",
                "players.reset_button": "Reset Players",
                "messages.confirm_delete": "Are you sure you want to clear all scores?",
                "messages.email_sent": "Results sent successfully!",
                "messages.email_error": "Error sending email. Please try again.",
                "instructions.title": "Instructions",
                "instructions.participants": "Instructions for Player Selection",
                "instructions.search": "Search Players: Type a player name to find them quickly",
                "instructions.select": "Select Players: Click on player cards to select/deselect them",
                "instructions.add_new": "Add New: Enter a name and click \"Add\" to add new players",
                "instructions.delete": "Delete: Click the ‚úï button on a player card to remove them",
                "instructions.select_all": "Select All: Click the ‚úì button to select/deselect all visible players",
                "instructions.history": "History: View your last 5 tournaments in the Tournament History section below",
                "instructions.continue": "Continue: Once you've selected players, click \"Start Match\"",
                "instructions.config": "Instructions for Tournament Configuration",
                "instructions.targets": "Number of Targets: How many targets will each player shoot at?",
                "instructions.bullets": "Bullets per Target: How many bullets/shots per target?",
                "instructions.total": "Total Shots: Automatically calculated (Targets √ó Bullets)",
                "instructions.example": "Example: 20 targets √ó 2 bullets = 40 total shots",
                "instructions.config_continue": "Continue: Click \"Next\" to start entering scores",
                "instructions.scoring": "Instructions for Score Entry",
                "instructions.range": "Score Range: Enter scores from 0 to 10",
                "instructions.miss": "0 = Miss: No points for that shot",
                "instructions.regular": "1-9 = Regular: Points for partial hits",
                "instructions.perfect": "10 = Perfect: Perfect shot (highlighted in YELLOW ‚ú®)",
                "instructions.auto_cap": "Auto-Cap: Values over 10 automatically become 10",
                "instructions.real_time": "Real-Time Updates: Totals update as you type",
                "instructions.auto_save": "Auto-Save: All data saves automatically",
                "instructions.finish": "Finish: Click \"Finish Match\" when all scores are entered",
                "instructions.excel_export": "Excel Export: After finishing, download a detailed Excel report with all individual shot scores",
                "pwa.install_title": "Install App",
                "pwa.install_text": "Add SDK Muta Kalkulator to your home screen for quick access!",
                "pwa.install_btn": "Install",
                "pwa.install_later": "Later",
                "excel.library_not_loaded": "Excel library not loaded yet. Please wait a moment and try again.",
                "excel.no_results": "No results to export. Please complete the tournament first.",
                "excel.export_error": "Error exporting to Excel:"
            },
            sl: {
                "tournament.tournament": "Turneja",
                "players.player_management": "Upravljanje igralcev",
                "players.player": "Igralec",
                "players.name_placeholder": "Ime igralca...",
                "league.search_players_placeholder": "Iskanje igralcev...",
                "league.no_players_selected": "Prosimo, izberite vsaj enega igralca!",
                "general.next": "Naprej",
                "general.back": "Nazaj",
                "navigation.back": "Nazaj",
                "navigation.next": "Naprej",
                "navigation.start_match": "Zaƒçni tekmo",
                "players.select_all": "‚úì Vse",
                "players.deselect_all": "‚úï Nobenih",
                "general.save": "Preuzmite Excel",
                "general.status": "Naboji na tarƒço:",
                "tournament.targets": "≈†tevilo tarƒç:",
                "tournament.shots_per_target": "Strelov na tarƒço:",
                "general.new_tournament": "Zaƒçni novi Turnir",
                "tournament.tournament_setup": "Nastavitev Turnirja",
                "tournament_types.4_targets": "4 Tarƒçe",
                "tournament_types.4_targets_desc": "Hiter format (5 strelov vsako)",
                "tournament_types.20_targets": "20 Tarƒç",
                "tournament_types.20_targets_desc": "Standardni format (2 strela vsako)",
                "tournament_types.40_targets": "40 Tarƒç",
                "tournament_types.40_targets_desc": "Raz≈°irjen format (2 strela vsako)",
                "tournament.participants": "Udele≈æenci",
                "results.total_shots": "Skupno ≈°tevilo strelov",
                "results.final_results": "Konƒçni rezultati",
                "results.title": "Rezultati Turnirja",
                "results.date": "Datum",
                "results.score": "Rezultat",
                "results.position": "Mesto",
                "results.tens": "Desetke",
                "results.total_score": "Skupni rezultat",
                "results.rankings": "Popolna Lestvica",
                "results.number_of_targets": "≈†tevilo tarƒç",
                "results.shots_per_target": "Strelov na tarƒço",
                "results.tournament_configuration": "Nastavitev Turnirja",
                "results.highest_score": "Najvi≈°ji rezultat",
                "results.most_tens": "Najveƒç Desetek",
                "results.export_excel": "Prenesi Excel",
                "results.export_json": "Prenesi JSON",
                "results.export_pdf": "Natisni/PDF",
                "results.view_history": "Poglej zgodovino",
                "results.history_title": "Zgodovina Turnirjev",
                "results.no_history": "Ni turnirjev. Zaƒçni turnir, da zgradimo zgodovino!",
                "results.targets": "tarƒç",
                "results.shots": "strelov",
                "results.points": "toƒçk",
                "results.pts": "toƒçk",
                "results.players": "igralci",
                "scoring.enter_scores": "Vnos rezultatov",
                "scoring.clear_all": "Poƒçisti vse",
                "scoring.finish_tournament": "Zakljuƒçi tekmo",
                "scoring.target": "Tarƒça",
                "players.include_participant": "Vkljuƒçi udele≈æenca",
                "players.add_new_player": "Dodaj novega igralca",
                "players.add_button": "Dodaj",
                "players.reset_button": "Resetiraj igralce",
                "messages.confirm_delete": "Ali ste prepriƒçani, da ≈æelite izbrisati vse rezultate?",
                "messages.email_sent": "Rezultati so bili uspe≈°no poslani!",
                "messages.email_error": "Napaka pri po≈°iljanju e-po≈°te. Prosimo, poskusite znova.",
                "instructions.title": "Navodila",
                "instructions.participants": "Navodila za izbiro igralcev",
                "instructions.search": "Iskanje igralcev: Vnesite ime igralca za hitro iskanje",
                "instructions.select": "Izberi igralce: Klikni na kartice igralcev za izbiro/odselekcioniraj jih",
                "instructions.add_new": "Dodaj novega: Vnesite ime in kliknite \"Dodaj\" za dodajanje novih igralcev",
                "instructions.delete": "Izbri≈°i: Kliknite gumb ‚úï na kartici igralca za njihovo odstranitev",
                "instructions.select_all": "Izberi vse: Kliknite gumb ‚úì za izbiro/odselekcioniraj vse vidne igralce",
                "instructions.history": "Zgodovina: Oglejte si va≈°ih zadnjih 5 turnirjev v razdelku Zgodovina Turnirjev spodaj",
                "instructions.continue": "Nadaljuj: Ko ste izbrali igralce, kliknite \"Zaƒçni tekmo\"",
                "instructions.config": "Navodila za konfiguracija turnirja",
                "instructions.targets": "≈†tevilo tarƒç: Koliko tarƒç bo vsak igralec streljal?",
                "instructions.bullets": "Naboji na tarƒço: Koliko nabojev/strelov na tarƒço?",
                "instructions.total": "Skupni strelov: Samodejno izraƒçunano (Tarƒçe √ó Naboji)",
                "instructions.example": "Primer: 20 tarƒç √ó 2 naboja = 40 skupnih strelov",
                "instructions.config_continue": "Nadaljuj: Kliknite \"Naprej\" za zaƒçetek vnosa rezultatov",
                "instructions.scoring": "Navodila za vnos rezultatov",
                "instructions.range": "Razpon rezultatov: Vnesite rezultate od 0 do 10",
                "instructions.miss": "0 = Zmanka: Brez toƒçk za ta strel",
                "instructions.regular": "1-9 = Normalno: Toƒçke za delne zadetke",
                "instructions.perfect": "10 = Popolno: Popoln strel (oznaƒçen v RUMENI barvi ‚ú®)",
                "instructions.auto_cap": "Samodejni zgornji limit: Vrednosti nad 10 postanejo 10",
                "instructions.real_time": "Posodabljanje v realnem ƒçasu: Skupni znesek se posodablja med pisanjem",
                "instructions.auto_save": "Samodejno shranjevanje: Vsi podatki se samodejno shranijo",
                "instructions.finish": "Zakljuƒçi: Kliknite \"Zakljuƒçi Tekmo\" ko so vsi rezultati vneseni",
                "instructions.excel_export": "Excel izvoz: Po zakljuƒçku prenesite podrobno Excel poroƒçilo z vsemi rezultati posameznih strelov",
                "pwa.install_title": "Namestite aplikacijo",
                "pwa.install_text": "Dodajte SDK Muta Kalkulator na domaƒço plo≈°ƒço za hiter dostop!",
                "pwa.install_btn": "Namestite",
                "pwa.install_later": "Pozneje",
                "excel.library_not_loaded": "Excel knji≈ænica ≈°e ni nalo≈æena. Prosimo, poƒçakajte trenutek in poskusite znova.",
                "excel.no_results": "Ni rezultatov za izvoz. Prosimo, najprej zakljuƒçite turnir.",
                "excel.export_error": "Napaka pri izvozu v Excel:"
            }
        };

        // ===== APPLICATION STATE =====
        const app = {
            language: 'sl',
            selectedPlayers: [],
            allPlayers: [],
            defaultPlayers: [],
            tournamentConfig: { targets: 20, bulletsPerTarget: 2, totalShots: 40 },
            scores: {},
            lastResults: null,
            lastScores: null,
            lastPlayers: null
        };

        /* ===== INDEXEDDB STORAGE HANDLERS ===== */
        const DB_NAME = 'tournament_db';
        const STORE_NAME = 'players';
        const HISTORY_STORE_NAME = 'tournament_history';
        const TOURNAMENT_STATE_KEY = 'tournament_state_v1';
        let db = null;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);

                request.onerror = () => {
                    console.error('[App] IndexedDB open error:', request.error);
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log('[App] IndexedDB opened successfully');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        console.log('[App] Created players object store');
                    }
                    if (!database.objectStoreNames.contains(HISTORY_STORE_NAME)) {
                        database.createObjectStore(HISTORY_STORE_NAME, { keyPath: 'timestamp' });
                        console.log('[App] Created tournament history object store');
                    }
                };
            });
        }

        function loadPlayersFromStorage() {
            if (!db) {
                console.warn('[App] Database not initialized, using in-memory');
                app.allPlayers = [...app.defaultPlayers];
                return Promise.resolve();
            }

            return new Promise((resolve) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    if (request.result.length > 0) {
                        app.allPlayers = request.result;
                        console.log('[App] Loaded players from IndexedDB:', app.allPlayers.length);
                    } else {
                        console.log('[App] No players in IndexedDB, using defaults');
                        app.allPlayers = [...app.defaultPlayers];
                    }
                    resolve();
                };

                request.onerror = () => {
                    console.warn('[App] Error loading from IndexedDB, using defaults');
                    app.allPlayers = [...app.defaultPlayers];
                    resolve();
                };
            });
        }

        function savePlayersToStorage() {
            if (!db) {
                console.warn('[App] Database not initialized, cannot save');
                return Promise.reject('DB not initialized');
            }

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                // Clear all and re-add
                store.clear();

                app.allPlayers.forEach(player => {
                    store.add(player);
                });

                transaction.oncomplete = () => {
                    console.log('[App] Players saved to IndexedDB:', app.allPlayers.length);
                    resolve();
                };

                transaction.onerror = () => {
                    console.error('[App] Error saving to IndexedDB:', transaction.error);
                    reject(transaction.error);
                };
            });
        }

        function resetPlayerDatabase() {
            if (confirm("Reset player database to default?")) {
                if (!db) {
                    app.allPlayers = [...app.defaultPlayers];
                    renderPlayersList();
                    alert("Player database reset!");
                    return;
                }

                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.clear();

                transaction.oncomplete = () => {
                    app.allPlayers = [...app.defaultPlayers];
                    renderPlayersList();
                    alert("Player database reset!");
                };
            }
        }

        /**
         * Save current tournament state to localStorage
         */
        function saveTournamentState() {
            const state = {
                selectedPlayers: app.selectedPlayers,
                tournamentConfig: app.tournamentConfig,
                scores: app.scores,
                currentView: document.querySelector('.view.active')?.id || 'view-participants',
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(TOURNAMENT_STATE_KEY, JSON.stringify(state));
            console.log('[App] Tournament state saved');
        }

        /**
         * Load tournament state from localStorage
         */
        function loadTournamentState() {
            const stored = localStorage.getItem(TOURNAMENT_STATE_KEY);
            if (!stored) {
                console.log('[App] No saved tournament state found');
                return null;
            }

            try {
                const state = JSON.parse(stored);
                console.log('[App] Tournament state loaded:', state);
                return state;
            } catch (e) {
                console.warn('[App] Error loading tournament state:', e);
                return null;
            }
        }

        /**
         * Restore tournament state from localStorage
         */
        function restoreTournamentState() {
            const state = loadTournamentState();
            if (!state) return;

            // Restore tournament data
            app.selectedPlayers = state.selectedPlayers || [];
            app.tournamentConfig = state.tournamentConfig || { targets: 20, bulletsPerTarget: 2, totalShots: 40 };
            app.scores = state.scores || {};

            // Re-render the player list to show previously selected players as selected
            if (app.selectedPlayers.length > 0) {
                renderPlayersList();
            }

            // Log restoration
            if (app.selectedPlayers.length > 0) {
                console.log('[App] Restoring tournament with players:', app.selectedPlayers.map(p => p.name));
            }
        }

        /**
         * Clear saved tournament state
         */
        function clearTournamentState() {
            localStorage.removeItem(TOURNAMENT_STATE_KEY);
            app.selectedPlayers = [];
            app.scores = {};
            app.lastResults = null;
            app.lastScores = null;
            app.lastPlayers = null;
            console.log('[App] Tournament state cleared');
        }

        /* ===== TRANSLATION, VIEW, and UTILITY FUNCTIONS ===== */
        /* (unchanged ‚Äî t(), changeLanguage(), updateAllTranslations(), goToView() etc.) */

        /* ===== VIEW 1: PARTICIPANT SELECTION ===== */
        function loadPlayers() {
            loadPlayersFromStorage();
            renderPlayersList();
        }

        /* Add Player Function */
        async function addPlayer(name) {
            if (!name.trim()) return;
            const newId = Math.max(0, ...app.allPlayers.map(p => p.id)) + 1;
            const newPlayer = { id: newId, name: name.trim(), enabled: true };
            app.allPlayers.push(newPlayer);

            try {
                await savePlayersToStorage();
                console.log('[App] Player added and saved:', newPlayer, 'Total players:', app.allPlayers.length);
            } catch (e) {
                console.error('[App] Error saving player:', e);
            }

            // Clear search to show all players including the newly added one
            document.getElementById('player-search').value = '';
            renderPlayersList();
        }

        /* Delete player and save to storage */
        async function deleteSelectedPlayer(event, playerId) {
            event.stopPropagation();
            const index = app.allPlayers.findIndex(p => p.id === playerId);
            if (index >= 0 && confirm("Delete this player?")) {
                app.allPlayers.splice(index, 1);
                app.selectedPlayers = app.selectedPlayers.filter(p => p.id !== playerId);
                try {
                    await savePlayersToStorage();
                    console.log('[App] Player deleted and saved');
                } catch (e) {
                    console.error('[App] Error deleting player:', e);
                }
                renderPlayersList();
            }
        }

        /* ===== UI: Add Player + Reset Button ===== */
        function createPlayerControlBar() {
            const controlBar = document.createElement('div');
            controlBar.style.cssText = `
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                align-items: flex-end;
            `;

            controlBar.innerHTML = `
                <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="font-weight: 600; color: #2c3e50; font-size: 0.95rem;" data-i18n="players.add_new_player">Add new player</label>
                    <input id="new-player-name" type="text" placeholder="Player name..." data-i18n-placeholder="players.name_placeholder" style="padding:0.8rem; border:2px solid #e9ecef; border-radius:8px; font-size: 1rem; transition: all 0.2s ease;">
                </div>
                <button class="btn btn-primary" id="add-player-btn" style="margin-bottom: 0;" data-i18n="players.add_button">Add</button>
            `;

            const playersList = document.getElementById('players-list');
            playersList.insertAdjacentElement('afterend', controlBar);

            // Apply translations to dynamically created elements
            updateAllTranslations();

            document.getElementById('add-player-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('new-player-name');
                addPlayer(nameInput.value);
                nameInput.value = '';
                nameInput.focus();
            });

            // Allow Enter key to add player
            document.getElementById('new-player-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('add-player-btn').click();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize IndexedDB first
            try {
                await initDB();
            } catch (e) {
                console.warn('[App] IndexedDB init failed, using in-memory storage:', e);
            }

            // Load language preference
            const savedLanguage = localStorage.getItem('app_language');
            if (savedLanguage && (savedLanguage === 'en' || savedLanguage === 'sl')) {
                app.language = savedLanguage;
                document.documentElement.lang = savedLanguage;

                // Update language button active state
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase() === savedLanguage) {
                        btn.classList.add('active');
                    }
                });
            }

            // Load players after DB is ready
            await loadPlayersFromStorage();

            // Render the loaded players
            renderPlayersList();

            // Load and display tournament history on participants page
            displayParticipantsPageHistory();

            createPlayerControlBar();
            updateAllTranslations();

            // Initialize help button (show on participant selection page)
            updateHelpButton('view-participants');

            // Restore previous tournament state if exists
            // (moved to end to ensure translations are loaded first)
            setTimeout(() => {
                restoreTournamentState();
            }, 100);
        });

        // ===== UTILITY FUNCTIONS =====

        /**
         * Get translated string by key
         */
        function t(key) {
            return translations[app.language][key] || key;
        }

        /**
         * Change application language
         */
        function changeLanguage(lang) {
            app.language = lang;
            document.documentElement.lang = lang;

            // Save language preference to localStorage
            localStorage.setItem('app_language', lang);

            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update all translated elements
            updateAllTranslations();
            updateInstallPromptText();

            // Update navbar title in new language
            const currentView = document.querySelector('.view.active');
            if (currentView) {
                const viewId = currentView.id;
                updateNavbarTitle(viewId);
            }
        }

        /**
         * Update all text elements with translations
         */
        function updateAllTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
        }

        /**
         * Switch between views
         */
        function goToView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0);

            // Hide instructions when switching views
            hideInstructions();

            // Show help button only on non-results pages
            updateHelpButton(viewId);

            // Update navbar title based on view
            updateNavbarTitle(viewId);
        }

        /**
         * Update navbar title based on current view
         */
        function updateNavbarTitle(viewId) {
            const navbarTitle = document.getElementById('navbar-title');
            const titles = {
                'view-participants': 'players.player_management',
                'view-config': 'tournament.tournament_setup',
                'view-scoring': 'scoring.enter_scores',
                'view-results': 'results.final_results'
            };

            if (titles[viewId]) {
                const titleText = t(titles[viewId]);
                navbarTitle.textContent = titleText;
            }
        }

        /**
         * Toggle instructions visibility
         */
        function toggleInstructions() {
            const helpBtn = document.getElementById('help-toggle-btn');
            const currentView = document.querySelector('.view.active');
            if (!currentView) return;

            const instructionsPanel = currentView.querySelector('.instructions-panel');
            if (!instructionsPanel) return;

            instructionsPanel.classList.toggle('active');
            helpBtn.classList.toggle('active');
        }

        /**
         * Show instructions
         */
        function showInstructions() {
            const currentView = document.querySelector('.view.active');
            if (!currentView) return;

            const instructionsPanel = currentView.querySelector('.instructions-panel');
            if (!instructionsPanel) return;

            instructionsPanel.classList.add('active');
            document.getElementById('help-toggle-btn').classList.add('active');
        }

        /**
         * Hide instructions
         */
        function hideInstructions() {
            const instructionsPanels = document.querySelectorAll('.instructions-panel');
            instructionsPanels.forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById('help-toggle-btn').classList.remove('active');
        }

        /**
         * Toggle collapsible sections
         */
        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            button.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        /**
         * Update player count in collapsible header
         */
        function updatePlayerCounter() {
            const playersCounter = document.getElementById('players-counter');
            const allPlayers = app.allPlayers.length;
            if (playersCounter) {
                playersCounter.textContent = `(${allPlayers})`;
            }
        }

        /**
         * Update tournament history counter
         */
        function updateHistoryCounter(count) {
            const historyCounter = document.getElementById('history-counter');
            if (historyCounter) {
                historyCounter.textContent = `(${count}/5)`;
            }
        }

        /**
         * Update help button visibility based on current view
         */
        function updateHelpButton(viewId) {
            const helpBtn = document.getElementById('help-toggle-btn');
            // Hide help button on results view
            if (viewId === 'view-results') {
                helpBtn.style.display = 'none';
            } else {
                helpBtn.style.display = 'block';
            }
        }

        // ===== VIEW 1: PARTICIPANT SELECTION =====

        /**
         * Render players list UI
         */
        function renderPlayersList() {
            const container = document.getElementById('players-list');
            container.innerHTML = '';

            app.allPlayers.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                if (app.selectedPlayers.some(p => p.id === player.id)) {
                    card.classList.add('selected');
                }

                card.innerHTML = `
                    <div class="player-checkbox"></div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-id">ID: ${player.id}</div>
                    </div>
                    <button class="player-delete-btn" title="Delete player" onclick="event.stopPropagation(); deleteSelectedPlayer(event, ${player.id})">‚úï</button>
                `;

                card.addEventListener('click', (e) => {
                    togglePlayerSelection(player);
                });
                container.appendChild(card);
            });

            updatePlayerCounter();
            updateToggleButtonText();
        }

        /**
         * Toggle player selection
         */
        function togglePlayerSelection(player) {
            const index = app.selectedPlayers.findIndex(p => p.id === player.id);
            if (index >= 0) {
                app.selectedPlayers.splice(index, 1);
            } else {
                app.selectedPlayers.push(player);
            }
            renderPlayersList();
            saveTournamentState();
        }

        /**
         * Toggle all players selection - single button that toggles between all/none
         */
        function toggleAllPlayersButton() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const visiblePlayers = app.allPlayers.filter(player =>
                player.name.toLowerCase().includes(searchTerm)
            );

            // Check if all visible players are already selected
            const allSelected = visiblePlayers.length > 0 &&
                visiblePlayers.every(p => app.selectedPlayers.some(sp => sp.id === p.id));

            if (allSelected) {
                // If all are selected, deselect all
                app.selectedPlayers = [];
            } else {
                // Otherwise, select all visible players
                app.selectedPlayers = [...visiblePlayers];
            }

            renderPlayersList();
            updateToggleButtonText();
            saveTournamentState();
        }

        /**
         * Update toggle button icon based on selection state
         */
        function updateToggleButtonText() {
            const toggleBtn = document.getElementById('toggle-all-btn');
            if (!toggleBtn) return;

            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const visiblePlayers = app.allPlayers.filter(player =>
                player.name.toLowerCase().includes(searchTerm)
            );

            // Check if all visible players are selected
            const allSelected = visiblePlayers.length > 0 &&
                visiblePlayers.every(p => app.selectedPlayers.some(sp => sp.id === p.id));

            if (allSelected && visiblePlayers.length > 0) {
                toggleBtn.textContent = '‚úï';
                toggleBtn.title = 'Deselect all';
            } else {
                toggleBtn.textContent = '‚úì';
                toggleBtn.title = 'Select all';
            }
        }

        /**
         * Filter players based on search input
         */
        function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value.toLowerCase();
            const visiblePlayers = app.allPlayers.filter(player =>
                player.name.toLowerCase().includes(searchTerm)
            );

            const container = document.getElementById('players-list');
            container.innerHTML = '';

            visiblePlayers.forEach(player => {
                const card = document.createElement('div');
                card.className = 'player-card';
                if (app.selectedPlayers.some(p => p.id === player.id)) {
                    card.classList.add('selected');
                }

                card.innerHTML = `
                    <div class="player-checkbox"></div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-id">ID: ${player.id}</div>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    togglePlayerSelection(player);
                });
                container.appendChild(card);
            });
            updateToggleButtonText();
        }

        /**
         * Proceed to tournament configuration
         */
        function proceedToConfig() {
            if (app.selectedPlayers.length === 0) {
                alert(t('league.no_players_selected'));
                return;
            }
            goToView('view-config');
        }

        // ===== VIEW 2: TOURNAMENT CONFIGURATION =====

        /**
         * Update total shots based on targets and bullets input
         */
        function updateTotalShots() {
            const targetsInput = document.getElementById('targets-input');
            const bulletsInput = document.getElementById('bullets-per-target');

            const targets = Math.max(1, parseInt(targetsInput.value) || 20);
            const bullets = Math.max(1, parseInt(bulletsInput.value) || 2);

            app.tournamentConfig.targets = targets;
            app.tournamentConfig.bulletsPerTarget = bullets;

            const totalShots = targets * bullets;
            app.tournamentConfig.totalShots = totalShots;

            document.getElementById('total-shots-display').textContent = totalShots;
            saveTournamentState();
        }

        /**
         * Proceed to scoring
         */
        function proceedToScoring() {
            // Initialize score tracking
            app.selectedPlayers.forEach(player => {
                app.scores[player.id] = {};
                for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                    app.scores[player.id][i] = {};
                    for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                        app.scores[player.id][i][j] = null;
                    }
                }
            });

            // Update scoring info
            renderScoringCards();
            goToView('view-scoring');
        }

        // ===== VIEW 3: SCORE ENTRY =====

        /**
         * Render scoring input cards for each player
         */
        function renderScoringCards() {
            const container = document.getElementById('scores-container');
            container.innerHTML = '';

            app.selectedPlayers.forEach(player => {
                const card = document.createElement('div');
                card.className = 'score-card';

                let targetsHTML = '';
                for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                    targetsHTML += `
                        <div class="target">
                            <label data-i18n="scoring.target">${t('scoring.target')} ${i}</label>
                    `;
                    for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                        targetsHTML += `
                            <input type="number"
                                   min="0"
                                   max="10"
                                   placeholder="S${j}"
                                   id="score-${player.id}-${i}-${j}"
                                   onchange="validateAndUpdateScore(${player.id}, ${i}, ${j})"
                                   onkeyup="validateAndUpdateScore(${player.id}, ${i}, ${j})"
                                   oninput="validateAndUpdateScore(${player.id}, ${i}, ${j})">
                        `;
                    }
                    targetsHTML += '</div>';
                }

                card.innerHTML = `
                    <div class="score-header">
                        <div class="score-player-name">${player.name}</div>
                    </div>
                    <div class="targets-grid">
                        ${targetsHTML}
                    </div>
                    <div class="score-summary">
                        <div class="summary-item">
                            <label data-i18n="results.total_shots">${t('results.total_shots')}</label>
                            <div class="value" id="summary-score-${player.id}">0</div>
                        </div>
                        <div class="summary-item">
                            <label data-i18n="results.tens">${t('results.tens')}</label>
                            <div class="value" id="summary-tens-${player.id}">0</div>
                        </div>
                    </div>
                `;

                container.appendChild(card);

                // Restore saved score values if they exist
                if (app.scores[player.id]) {
                    for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                        for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                            const input = document.getElementById(`score-${player.id}-${i}-${j}`);
                            const savedScore = app.scores[player.id]?.[i]?.[j];
                            if (input && savedScore !== null && savedScore !== undefined) {
                                input.value = savedScore;
                                if (savedScore === 10) {
                                    input.classList.add('value-ten');
                                }
                            }
                        }
                    }
                    // Update the summary display
                    updateScoreSummary(player.id);
                }
            });
        }

        /**
         * Update score and tens summary for a player
         */
        function updateScoreSummary(playerId) {
            let totalScore = 0;
            let tensCount = 0;

            for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                    const input = document.getElementById(`score-${playerId}-${i}-${j}`);
                    if (input && input.value !== '') {
                        const value = parseInt(input.value);
                        if (!isNaN(value)) {
                            totalScore += value;
                            if (value === 10) {
                                tensCount++;
                            }
                        }
                    }
                }
            }

            document.getElementById(`summary-score-${playerId}`).textContent = totalScore;
            document.getElementById(`summary-tens-${playerId}`).textContent = tensCount;

            // Store in app state
            app.scores[playerId].totalScore = totalScore;
            app.scores[playerId].tensCount = tensCount;

            // Auto-save tournament state after score update
            saveTournamentState();
        }

        /**
         * Validate score input and prevent values over 10, apply yellow highlight for 10s
         */
        function validateAndUpdateScore(playerId, targetId, bulletId) {
            const input = document.getElementById(`score-${playerId}-${targetId}-${bulletId}`);
            if (!input) return;

            let value = input.value;

            // Allow empty values
            if (value === '') {
                input.classList.remove('value-ten');
                // Clear the score in app.scores
                if (app.scores[playerId]?.[targetId]) {
                    app.scores[playerId][targetId][bulletId] = null;
                }
                updateScoreSummary(playerId);
                return;
            }

            // Parse the value
            let numValue = parseInt(value);

            // If not a valid number, clear it
            if (isNaN(numValue)) {
                input.value = '';
                input.classList.remove('value-ten');
                updateScoreSummary(playerId);
                return;
            }

            // Prevent values over 10
            if (numValue > 10) {
                input.value = '10';
                numValue = 10;
            }

            // Prevent negative values
            if (numValue < 0) {
                input.value = '0';
                numValue = 0;
            }

            // Apply yellow styling for 10s
            if (numValue === 10) {
                input.classList.add('value-ten');
            } else {
                input.classList.remove('value-ten');
            }

            // Save the score value to app.scores
            if (!app.scores[playerId]) {
                app.scores[playerId] = {};
            }
            if (!app.scores[playerId][targetId]) {
                app.scores[playerId][targetId] = {};
            }
            app.scores[playerId][targetId][bulletId] = numValue;

            // Update the summary
            updateScoreSummary(playerId);
        }

        /**
         * Clear all scores
         */
        function clearAllScores() {
            if (confirm(t('messages.confirm_delete'))) {
                document.querySelectorAll('.score-card input[type="number"]').forEach(input => {
                    input.value = '';
                });
                app.selectedPlayers.forEach(player => {
                    updateScoreSummary(player.id);
                });
            }
        }

        /**
         * Proceed to results
         */
        function proceedToResults() {
            // Calculate final results
            const results = calculateResults();

            // Save scores and players for Excel export
            app.lastScores = JSON.parse(JSON.stringify(app.scores)); // Deep copy
            app.lastPlayers = JSON.parse(JSON.stringify(app.selectedPlayers)); // Deep copy

            displayResults(results);
            saveTournamentToHistory();
            goToView('view-results');
        }

        // ===== VIEW 4: RESULTS DISPLAY =====

        /**
         * Calculate final results from scores
         */
        function calculateResults() {
            const results = app.selectedPlayers.map(player => ({
                id: player.id,
                name: player.name,
                totalScore: app.scores[player.id].totalScore || 0,
                tensCount: app.scores[player.id].tensCount || 0,
                totalShots: app.tournamentConfig.totalShots
            }));

            // Sort by score (DESC), then by tens (DESC)
            results.sort((a, b) => {
                if (b.totalScore !== a.totalScore) {
                    return b.totalScore - a.totalScore;
                }
                return b.tensCount - a.tensCount;
            });

            // Add position
            results.forEach((result, index) => {
                result.position = index + 1;
            });

            return results;
        }

        /**
         * Display results in table format
         */
        function displayResults(results) {
            const table = document.getElementById('results-table');
            const header = document.getElementById('results-header');

            // Update header with tournament type styling
            const tournamentType = app.tournamentConfig.type || '20_targets';
            header.className = `results-header tournament-${tournamentType}`;
            console.log('[App] Header class set to:', header.className, 'Tournament type:', tournamentType);

            // Update header statistics
            const highestScore = results.length > 0 ? results[0].totalScore : 0;
            const mostTens = results.length > 0 ? Math.max(...results.map(r => r.tensCount)) : 0;

            document.getElementById('header-participants').textContent = results.length;
            document.getElementById('header-targets').textContent = app.tournamentConfig.targets || 0;
            document.getElementById('header-shots').textContent = app.tournamentConfig.bulletsPerTarget || 0;
            document.getElementById('header-highest-score').textContent = highestScore;
            document.getElementById('header-most-tens').textContent = mostTens;

            let html = `
                <thead>
                    <tr>
                        <th class="rank-col">${t('results.position')}</th>
                        <th class="player-col">${t('players.player')}</th>
                        <th class="score-col">${t('results.total_score')}</th>
                        <th class="tens-col">${t('results.tens')}</th>
                    </tr>
                </thead>
                <tbody>
            `;

            results.forEach(result => {
                const rankClass = result.position <= 3 ? `rank-${result.position}` : 'rank-other';
                const medal = result.position === 1 ? 'ü•á' :
                             result.position === 2 ? 'ü•à' :
                             result.position === 3 ? 'ü•â' : '';

                html += `
                    <tr>
                        <td class="rank-cell ${rankClass}">${result.position} ${medal}</td>
                        <td class="player-cell"><div class="player-name">${result.name}</div></td>
                        <td class="score-cell">${result.totalScore}</td>
                        <td class="tens-cell">üéØ ${result.tensCount}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Store results for export
            app.lastResults = results;
        }

        // ===== EXCEL EXPORT =====

        /**
         * Download results as Excel file
         */
        function downloadExcel() {
            try {
                if (typeof XLSX === 'undefined') {
                    alert(t('excel.library_not_loaded'));
                    console.warn('[App] XLSX library not available');
                    return;
                }

                if (!app.lastResults || app.lastResults.length === 0) {
                    alert(t('excel.no_results'));
                    return;
                }

                console.log('[App] Starting Excel export with', app.lastResults.length, 'results');

                const wb = XLSX.utils.book_new();

                // Use Slovenian translations for Excel export
                const isSloven = app.language === 'sl';
                const positionLabel = isSloven ? 'Mesto' : 'Position';
                const playerLabel = isSloven ? 'Igralec' : 'Player';
                const scoreLabel = isSloven ? 'Skupni rezultat' : 'Total Score';
                const tensLabel = isSloven ? 'Desetke' : 'Tens';
                const titleLabel = isSloven ? 'Rezultati Turnirja' : 'Tournament Results';
                const dateLabel = isSloven ? 'Datum' : 'Date';
                const configLabel = isSloven ? 'Nastavitev' : 'Configuration';
                const targetsLabel = isSloven ? 'tarƒç' : 'targets';
                const shotsLabel = isSloven ? 'strelov na tarƒço' : 'shots per target';
                const targetLabel = isSloven ? 'Tarƒça' : 'Target';
                const shotLabel = isSloven ? 'Strel' : 'Shot';

                // Build detailed scores data with targets and bullets
                const detailedData = [];

                // Add header rows
                detailedData.push(['SDK Muta - Kalkulator']);
                detailedData.push([titleLabel]);
                detailedData.push([dateLabel + ': ' + new Date().toLocaleDateString()]);
                detailedData.push([configLabel + ': ' + app.tournamentConfig.targets + ' ' + targetsLabel + ' √ó ' + app.tournamentConfig.bulletsPerTarget + ' ' + shotsLabel]);
                detailedData.push([]);

                // Build compact header rows - Row 1: Target labels
                const headerRow1 = [positionLabel, playerLabel];
                for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                    headerRow1.push(`${targetLabel} ${i}`);
                    // Add empty cells for additional shots
                    for (let j = 1; j < app.tournamentConfig.bulletsPerTarget; j++) {
                        headerRow1.push('');
                    }
                }
                headerRow1.push(scoreLabel, tensLabel);
                detailedData.push(headerRow1);

                // Row 2: Shot labels (S1, S2, S3, etc.)
                const headerRow2 = ['', '']; // Empty for Position and Player columns
                for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                    for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                        headerRow2.push(`${shotLabel}${j}`);
                    }
                }
                headerRow2.push('', ''); // Empty for Total Score and Tens
                detailedData.push(headerRow2);

                // Use saved scores and players data for export
                const scoresData = app.lastScores || app.scores;
                const playersData = app.lastPlayers || app.selectedPlayers;

                console.log('[App] Excel export - using scores:', scoresData);
                console.log('[App] Excel export - using players:', playersData);

                // Add player data rows
                app.lastResults.forEach(result => {
                    const row = [result.position, result.name];

                    // Add all target/bullet scores using result.id (which is the player ID)
                    for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                        for (let j = 1; j <= app.tournamentConfig.bulletsPerTarget; j++) {
                            const score = scoresData[result.id]?.[i]?.[j];
                            row.push(score !== null && score !== undefined ? score : 0);
                        }
                    }

                    row.push(result.totalScore, result.tensCount);
                    detailedData.push(row);
                });

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(detailedData);

                // Merge cells for target headers (row 5) - each target header spans multiple shot columns
                const merges = [];
                // Merge Position and Player cells across both header rows
                merges.push({ s: { r: 5, c: 0 }, e: { r: 6, c: 0 } }); // Position
                merges.push({ s: { r: 5, c: 1 }, e: { r: 6, c: 1 } }); // Player

                // Merge each target header across its shot columns
                let colIndex = 2; // Start after Position and Player
                for (let i = 1; i <= app.tournamentConfig.targets; i++) {
                    if (app.tournamentConfig.bulletsPerTarget > 1) {
                        merges.push({
                            s: { r: 5, c: colIndex },
                            e: { r: 5, c: colIndex + app.tournamentConfig.bulletsPerTarget - 1 }
                        });
                    }
                    colIndex += app.tournamentConfig.bulletsPerTarget;
                }

                // Merge Total Score and Tens headers
                const totalScoreCol = 2 + app.tournamentConfig.targets * app.tournamentConfig.bulletsPerTarget;
                merges.push({ s: { r: 5, c: totalScoreCol }, e: { r: 6, c: totalScoreCol } }); // Total Score
                merges.push({ s: { r: 5, c: totalScoreCol + 1 }, e: { r: 6, c: totalScoreCol + 1 } }); // Tens

                ws['!merges'] = merges;

                // Set column widths - more compact
                const cols = [
                    { wch: 8 },   // Position
                    { wch: 18 }   // Player
                ];
                for (let i = 0; i < app.tournamentConfig.targets * app.tournamentConfig.bulletsPerTarget; i++) {
                    cols.push({ wch: 5 }); // Shot columns - compact
                }
                cols.push({ wch: 10 }); // Total Score
                cols.push({ wch: 6 });  // Tens
                ws['!cols'] = cols;

                // Apply cell styling
                const range = XLSX.utils.decode_range(ws['!ref']);

                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cellAddress]) continue;

                        // Initialize cell style
                        if (!ws[cellAddress].s) ws[cellAddress].s = {};

                        // Header styling (rows 0-3)
                        if (R <= 3) {
                            ws[cellAddress].s = {
                                font: { bold: true, sz: R === 0 ? 16 : 12, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "2E5090" } },
                                alignment: { horizontal: "left", vertical: "center" }
                            };
                        }
                        // Column headers row 1: Target labels (row 5)
                        else if (R === 5) {
                            ws[cellAddress].s = {
                                font: { bold: true, sz: 11, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "4472C4" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: {
                                    top: { style: "medium", color: { rgb: "000000" } },
                                    bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                    left: { style: "thin", color: { rgb: "000000" } },
                                    right: { style: "thin", color: { rgb: "000000" } }
                                }
                            };
                        }
                        // Column headers row 2: Shot labels (row 6)
                        else if (R === 6) {
                            ws[cellAddress].s = {
                                font: { bold: true, sz: 10, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "5B8FD8" } },
                                alignment: { horizontal: "center", vertical: "center" },
                                border: {
                                    top: { style: "thin", color: { rgb: "D0D0D0" } },
                                    bottom: { style: "medium", color: { rgb: "000000" } },
                                    left: { style: "thin", color: { rgb: "000000" } },
                                    right: { style: "thin", color: { rgb: "000000" } }
                                }
                            };
                        }
                        // Data rows
                        else if (R > 6) {
                            const cellValue = ws[cellAddress].v;
                            let fillColor = "FFFFFF"; // Default white

                            // Color code the score cells
                            if (C >= 2 && C < 2 + app.tournamentConfig.targets * app.tournamentConfig.bulletsPerTarget) {
                                // Score columns
                                if (cellValue === 10) {
                                    fillColor = "C6EFCE"; // Light green for 10
                                    ws[cellAddress].s = {
                                        font: { bold: true, color: { rgb: "006100" } },
                                        fill: { fgColor: { rgb: fillColor } },
                                        alignment: { horizontal: "center", vertical: "center" },
                                        border: {
                                            top: { style: "thin", color: { rgb: "D0D0D0" } },
                                            bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                            left: { style: "thin", color: { rgb: "D0D0D0" } },
                                            right: { style: "thin", color: { rgb: "D0D0D0" } }
                                        }
                                    };
                                } else if (cellValue >= 9) {
                                    fillColor = "D4EDDA"; // Light blue-green for 9
                                    ws[cellAddress].s = {
                                        font: { color: { rgb: "155724" } },
                                        fill: { fgColor: { rgb: fillColor } },
                                        alignment: { horizontal: "center", vertical: "center" },
                                        border: {
                                            top: { style: "thin", color: { rgb: "D0D0D0" } },
                                            bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                            left: { style: "thin", color: { rgb: "D0D0D0" } },
                                            right: { style: "thin", color: { rgb: "D0D0D0" } }
                                        }
                                    };
                                } else if (cellValue >= 8) {
                                    fillColor = "FFF3CD"; // Light yellow for 8
                                    ws[cellAddress].s = {
                                        fill: { fgColor: { rgb: fillColor } },
                                        alignment: { horizontal: "center", vertical: "center" },
                                        border: {
                                            top: { style: "thin", color: { rgb: "D0D0D0" } },
                                            bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                            left: { style: "thin", color: { rgb: "D0D0D0" } },
                                            right: { style: "thin", color: { rgb: "D0D0D0" } }
                                        }
                                    };
                                } else if (cellValue >= 0) {
                                    fillColor = "F8D7DA"; // Light red for < 8
                                    ws[cellAddress].s = {
                                        fill: { fgColor: { rgb: fillColor } },
                                        alignment: { horizontal: "center", vertical: "center" },
                                        border: {
                                            top: { style: "thin", color: { rgb: "D0D0D0" } },
                                            bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                            left: { style: "thin", color: { rgb: "D0D0D0" } },
                                            right: { style: "thin", color: { rgb: "D0D0D0" } }
                                        }
                                    };
                                } else {
                                    // Empty cells
                                    ws[cellAddress].s = {
                                        fill: { fgColor: { rgb: "F5F5F5" } },
                                        alignment: { horizontal: "center", vertical: "center" },
                                        border: {
                                            top: { style: "thin", color: { rgb: "D0D0D0" } },
                                            bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                            left: { style: "thin", color: { rgb: "D0D0D0" } },
                                            right: { style: "thin", color: { rgb: "D0D0D0" } }
                                        }
                                    };
                                }
                            }
                            // Total score column
                            else if (C === 2 + app.tournamentConfig.targets * app.tournamentConfig.bulletsPerTarget) {
                                ws[cellAddress].s = {
                                    font: { bold: true, sz: 11 },
                                    fill: { fgColor: { rgb: "E7E6E6" } },
                                    alignment: { horizontal: "center", vertical: "center" },
                                    border: {
                                        top: { style: "thin", color: { rgb: "000000" } },
                                        bottom: { style: "thin", color: { rgb: "000000" } },
                                        left: { style: "medium", color: { rgb: "000000" } },
                                        right: { style: "thin", color: { rgb: "000000" } }
                                    }
                                };
                            }
                            // Tens column
                            else if (C === 3 + app.tournamentConfig.targets * app.tournamentConfig.bulletsPerTarget) {
                                ws[cellAddress].s = {
                                    font: { bold: true, sz: 11 },
                                    fill: { fgColor: { rgb: "E7E6E6" } },
                                    alignment: { horizontal: "center", vertical: "center" },
                                    border: {
                                        top: { style: "thin", color: { rgb: "000000" } },
                                        bottom: { style: "thin", color: { rgb: "000000" } },
                                        left: { style: "thin", color: { rgb: "000000" } },
                                        right: { style: "thin", color: { rgb: "000000" } }
                                    }
                                };
                            }
                            // Position and Player columns
                            else {
                                ws[cellAddress].s = {
                                    font: { bold: C === 0 },
                                    alignment: { horizontal: C === 0 ? "center" : "left", vertical: "center" },
                                    border: {
                                        top: { style: "thin", color: { rgb: "D0D0D0" } },
                                        bottom: { style: "thin", color: { rgb: "D0D0D0" } },
                                        left: { style: "thin", color: { rgb: "D0D0D0" } },
                                        right: { style: "thin", color: { rgb: "D0D0D0" } }
                                    }
                                };
                            }
                        }
                    }
                }

                XLSX.utils.book_append_sheet(wb, ws, 'Detailed Results');

                const filename = `tournament_results_${app.tournamentConfig.targets}targets_${new Date().toISOString().split('T')[0]}.xlsx`;

                console.log('[App] Exporting to file:', filename);
                XLSX.writeFile(wb, filename);
                console.log('[App] Export successful');
            } catch (error) {
                console.error('[App] Excel export error:', error);
                alert(t('excel.export_error') + ' ' + error.message);
            }
        }

        // ===== JSON EXPORT =====

        /**
         * Download results as JSON file
         */
        function downloadJSON() {
            try {
                if (!app.tournamentConfig || !app.selectedPlayers || !app.lastResults || app.lastResults.length === 0) {
                    alert(t('excel.no_results'));
                    console.warn('[App] Missing required data for JSON export:', {
                        tournamentConfig: !!app.tournamentConfig,
                        selectedPlayers: !!app.selectedPlayers,
                        lastResults: !!app.lastResults,
                        resultsLength: app.lastResults ? app.lastResults.length : 0
                    });
                    return;
                }

                console.log('[App] JSON export - scores:', app.scores);

                // Validate tournament type - only valid if it matches known configurations
                // Valid: 4 targets + 5 shots, 20 targets + 2 shots, 40 targets + 2 shots
                const isValidTournament =
                    (app.tournamentConfig.type === '4_targets' && app.tournamentConfig.targets === 4 && app.tournamentConfig.bulletsPerTarget === 5) ||
                    (app.tournamentConfig.type === '20_targets' && app.tournamentConfig.targets === 20 && app.tournamentConfig.bulletsPerTarget === 2) ||
                    (app.tournamentConfig.type === '40_targets' && app.tournamentConfig.targets === 40 && app.tournamentConfig.bulletsPerTarget === 2);

                const tournamentType = isValidTournament ? app.tournamentConfig.type : null;

                // Build the JSON structure matching the example format
                const tournamentData = {
                    tournament: {
                        rounds: [],
                        created_at: new Date().toISOString(),
                        total_players: app.selectedPlayers.length,
                        total_rounds: app.tournamentConfig.targets || 0,
                        current_round: 1,
                        tournament_type: tournamentType
                    },
                    results: {
                        tournament_id: new Date().toISOString(),
                        tournament_type: tournamentType,
                        participants: {},
                        tournament_finished: true,
                        created_at: new Date().toISOString(),
                        finished_at: new Date().toISOString()
                    },
                    archived_at: new Date().toISOString()
                };

                // Build participants data with scores from tournament state
                // Use same method as Excel export - lastScores or current scores
                const scoresData = app.lastScores || app.scores;

                if (app.lastResults && app.lastResults.length > 0) {
                    app.lastResults.forEach(result => {
                        const playerId = result.id;
                        const targets = {};

                        // Structure targets properly - each target contains shots (1-indexed)
                        // Use same access pattern as Excel export
                        for (let targetId = 1; targetId <= (app.tournamentConfig.targets || 0); targetId++) {
                            targets[targetId] = {};
                            for (let bulletId = 1; bulletId <= (app.tournamentConfig.bulletsPerTarget || 0); bulletId++) {
                                // Use optional chaining same as Excel export
                                const score = scoresData[playerId]?.[targetId]?.[bulletId];
                                targets[targetId][`shot${bulletId}`] = score !== null && score !== undefined ? parseInt(score) : 0;
                            }
                        }

                        tournamentData.results.participants[playerId] = {
                            name: result.name,
                            targets: targets,
                            total_score: result.totalScore || 0,
                            completed: true
                        };
                    });
                }

                // Create and download file
                const jsonString = JSON.stringify(tournamentData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const dateStr = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.href = url;
                link.download = `tournament_${dateStr}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log('[App] JSON export completed successfully');
            } catch (error) {
                console.error('[App] JSON export error:', error);
                alert(t('excel.export_error') + ' ' + error.message);
            }
        }

        // ===== PDF EXPORT =====

        /**
         * Print/export results as PDF
         */
        function downloadPDF() {
            try {
                // Generate filename with tournament details
                const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const targets = app.tournamentConfig.targets || 0;
                const shots = app.tournamentConfig.bulletsPerTarget || 0;
                const filename = `Tournament_${dateStr}_${targets}targets_${shots}shots`;

                // Set document title for PDF export
                const originalTitle = document.title;
                document.title = filename;

                // Trigger print dialog
                window.print();

                // Restore original title after print dialog closes
                // Note: This executes immediately but print dialog is asynchronous
                setTimeout(() => {
                    document.title = originalTitle;
                }, 100);

                console.log('[App] PDF export initiated with filename:', filename);
            } catch (error) {
                console.error('[App] PDF export error:', error);
                alert('Error exporting PDF: ' + error.message);
            }
        }

        /**
         * Save tournament to history (keep last 5)
         */
        function saveTournamentToHistory() {
            if (!db) {
                console.warn('[App] Database not initialized, cannot save history');
                return;
            }

            // Create history entry with timestamp as key
            const timestamp = new Date().getTime();
            const entry = {
                timestamp: timestamp,
                date: new Date().toISOString(),
                config: app.tournamentConfig,
                results: app.lastResults,
                scores: app.scores, // Save all detailed scores
                players: app.selectedPlayers, // Save player info for reference
                winner: app.lastResults && app.lastResults.length > 0 ? app.lastResults[0] : null
            };

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(HISTORY_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(HISTORY_STORE_NAME);

                // First, get all history entries to maintain last 5
                const getAllRequest = store.getAll();

                getAllRequest.onsuccess = () => {
                    const allHistory = getAllRequest.result;
                    // Sort by timestamp descending and keep only last 4 (so we add the new one as 5th)
                    allHistory.sort((a, b) => b.timestamp - a.timestamp);
                    const toDelete = allHistory.slice(4); // Keep only last 4, will add new one

                    // Delete old entries
                    toDelete.forEach(entry => {
                        store.delete(entry.timestamp);
                    });

                    // Add new entry
                    const addRequest = store.add(entry);

                    addRequest.onsuccess = () => {
                        console.log('[App] Tournament saved to IndexedDB history');
                        resolve();
                    };

                    addRequest.onerror = () => {
                        console.error('[App] Error adding to history:', addRequest.error);
                        reject(addRequest.error);
                    };
                };

                getAllRequest.onerror = () => {
                    console.error('[App] Error reading history:', getAllRequest.error);
                    reject(getAllRequest.error);
                };
            });
        }

        /**
         * Load tournament history from IndexedDB
         */
        function loadHistoryFromStorage() {
            if (!db) {
                console.warn('[App] Database not initialized, cannot load history');
                return Promise.resolve([]);
            }

            return new Promise((resolve) => {
                const transaction = db.transaction(HISTORY_STORE_NAME, 'readonly');
                const store = transaction.objectStore(HISTORY_STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const history = request.result;
                    // Sort by timestamp descending (most recent first)
                    history.sort((a, b) => b.timestamp - a.timestamp);
                    console.log('[App] Loaded history from IndexedDB:', history.length, 'entries');
                    resolve(history);
                };

                request.onerror = () => {
                    console.warn('[App] Error loading history from IndexedDB');
                    resolve([]);
                };
            });
        }

        /**
         * Delete tournament from history by timestamp
         */
        function deleteHistoryItem(timestamp) {
            if (!confirm('Delete this tournament from history?')) {
                return;
            }

            if (!db) {
                console.warn('[App] Database not initialized, cannot delete history');
                return;
            }

            const transaction = db.transaction(HISTORY_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(HISTORY_STORE_NAME);
            const deleteRequest = store.delete(timestamp);

            deleteRequest.onsuccess = () => {
                console.log('[App] Tournament deleted from history:', timestamp);
                // Refresh the history display
                displayParticipantsPageHistory();
                displayTournamentHistory();
            };

            deleteRequest.onerror = () => {
                console.error('[App] Error deleting from history:', deleteRequest.error);
                alert('Error deleting tournament from history');
            };
        }

        /**
         * Display tournament history
         */
        function displayTournamentHistory() {
            const historyEmpty = document.getElementById('history-empty');
            const historyList = document.getElementById('history-list');

            if (!historyList) {
                console.warn('[App] History list element not found');
                return;
            }

            historyList.innerHTML = '';

            loadHistoryFromStorage().then(history => {
                if (history.length === 0) {
                    if (historyEmpty) {
                        historyEmpty.style.display = 'block';
                    }
                    return;
                }

                if (historyEmpty) {
                    historyEmpty.style.display = 'none';
                }

                history.forEach((tournament, index) => {
                    const date = new Date(tournament.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
                    const configStr = `${tournament.config.targets} ${t('results.targets')} √ó ${tournament.config.bulletsPerTarget} ${t('results.shots')}`;
                    const topThree = tournament.results.slice(0, 3);

                    const card = document.createElement('div');
                    card.className = 'history-card';
                    card.innerHTML = `
                        <div class="history-card-date">${dateStr}</div>
                        <div class="history-card-config">${configStr}</div>
                        <div class="history-card-podium">
                            ${topThree.map((player, idx) => {
                                const medals = ['ü•á', 'ü•à', 'ü•â'];
                                return `
                                    <div class="podium-entry">
                                        <span class="medal">${medals[idx]}</span>
                                        <span class="name">${player.name}</span>
                                        <span class="score">${player.totalScore} ${t('results.pts')}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="history-card-players">
                            <strong>${tournament.results.length} ${t('results.players')}</strong>
                        </div>
                    `;

                    // Add click handler to restore tournament
                    card.addEventListener('click', () => {
                        restoreTournamentFromHistory(tournament);
                    });

                    historyList.appendChild(card);
                });
            });
        }

        /**
         * Restore a tournament from history and display results
         */
        function restoreTournamentFromHistory(tournament) {
            // Restore tournament data
            app.lastResults = tournament.results;
            app.tournamentConfig = tournament.config;

            // Display the results
            displayResults(tournament.results);

            // Navigate to results view
            goToView('view-results');

            console.log('[App] Restored tournament from history');
        }

        /**
         * Display history on the participants page
         */
        function displayParticipantsPageHistory() {
            const historyEmpty = document.getElementById('participants-history-empty');
            const historyList = document.getElementById('participants-history-list');

            if (!historyList) {
                console.warn('[App] Participants history list element not found');
                return;
            }

            historyList.innerHTML = '';

            loadHistoryFromStorage().then(history => {
                if (history.length === 0) {
                    if (historyEmpty) {
                        historyEmpty.style.display = 'block';
                    }
                    return;
                }

                if (historyEmpty) {
                    historyEmpty.style.display = 'none';
                }

                history.forEach((tournament, index) => {
                    const date = new Date(tournament.date);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString().slice(0, 5);
                    const configStr = `${tournament.config.targets} ${t('results.targets')} √ó ${tournament.config.bulletsPerTarget} ${t('results.shots')}`;
                    const topThree = tournament.results.slice(0, 3);

                    const card = document.createElement('div');
                    card.className = 'history-card';
                    card.style.cursor = 'pointer';
                    card.innerHTML = `
                        <button class="history-card-delete" title="Delete tournament" onclick="event.stopPropagation(); deleteHistoryItem(${tournament.timestamp})">‚úï</button>
                        <div class="history-card-date">${dateStr}</div>
                        <div class="history-card-config">${configStr}</div>
                        <div class="history-card-podium">
                            ${topThree.map((player, idx) => {
                                const medals = ['ü•á', 'ü•à', 'ü•â'];
                                return `
                                    <div class="podium-entry">
                                        <span class="medal">${medals[idx]}</span>
                                        <span class="name">${player.name}</span>
                                        <span class="score">${player.totalScore} ${t('results.pts')}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="history-card-players">
                            <strong>${tournament.results.length} ${t('results.players')}</strong>
                        </div>
                    `;

                    // Add click handler to restore tournament
                    card.addEventListener('click', () => {
                        restoreTournamentFromHistory(tournament);
                    });

                    // Add hover effect (border and shadow only, no movement)
                    card.addEventListener('mouseenter', () => {
                        card.style.borderColor = '#007bff';
                        card.style.boxShadow = '0 8px 16px rgba(0, 123, 255, 0.3)';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.borderColor = '#e9ecef';
                        card.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    });

                    historyList.appendChild(card);
                });

                // Update the counter with actual count
                updateHistoryCounter(history.length);
            });
        }

        /**
         * Show tournament history view
         */
        function showTournamentHistory() {
            displayTournamentHistory();
            goToView('view-history');
        }

        /**
         * Start new tournament
         */
        function startNewTournament() {
            clearTournamentState();
            document.getElementById('player-search').value = '';
            loadPlayers();
            // Reload history on participants page
            displayParticipantsPageHistory();
            goToView('view-participants');
        }

        // ===== SERVICE WORKER REGISTRATION =====
        /**
         * Register service worker for PWA functionality
         */
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('[App] Service Worker registered successfully:', registration);

                    // Check for updates periodically
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('[App] New Service Worker available, prompting user...');
                                // Prompt user about update (optional)
                                // You can add a notification here if desired
                            }
                        });
                    });
                }).catch(error => {
                    console.log('[App] Service Worker registration failed:', error);
                });
            } else {
                console.log('[App] Service Workers not supported');
            }
        }

        // Register service worker for PWA functionality (no DOMContentLoaded needed)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', registerServiceWorker);
        } else {
            registerServiceWorker();
        }

        // ===== PWA INSTALL PROMPT =====
        let deferredPrompt;
        const installPromptElement = document.createElement('div');
        installPromptElement.id = 'install-prompt';
        installPromptElement.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            max-width: 400px;
            z-index: 1000;
            display: none;
            font-family: inherit;
        `;

        function updateInstallPromptText() {
            const t = translations[app.language];
            installPromptElement.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">${t['pwa.install_title']}</h3>
                    <p style="margin: 0; font-size: 0.9rem; opacity: 0.95;">${t['pwa.install_text']}</p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="install-btn" style="flex: 1; padding: 0.75rem; background: white; color: #007bff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                        ${t['pwa.install_btn']}
                    </button>
                    <button id="install-close-btn" style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.2); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                        ${t['pwa.install_later']}
                    </button>
                </div>
            `;
        }

        document.body.appendChild(installPromptElement);
        updateInstallPromptText();

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            // Auto-trigger the install prompt
            setTimeout(() => {
                installPromptElement.style.display = 'block';
            }, 1000);
        });

        // Install button click handler
        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`[PWA] User response: ${outcome}`);
                if (outcome === 'accepted') {
                    console.log('[PWA] App installation accepted');
                }
                deferredPrompt = null;
                installPromptElement.style.display = 'none';
            }
        });

        // Close button click handler
        document.getElementById('install-close-btn').addEventListener('click', () => {
            installPromptElement.style.display = 'none';
            deferredPrompt = null;
        });

        // Function to request fullscreen
        function requestAppFullscreen() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().then(() => {
                    console.log('[PWA] Entered fullscreen mode');
                }).catch(err => {
                    console.log('[PWA] Fullscreen request failed:', err);
                });
            } else if (document.documentElement.webkitRequestFullscreen) {
                // Safari on iOS
                document.documentElement.webkitRequestFullscreen();
                console.log('[PWA] Entered fullscreen mode (webkit)');
            }
        }

        // Hide prompt on app installed and request fullscreen
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed successfully');
            installPromptElement.style.display = 'none';
            deferredPrompt = null;

            // Request fullscreen after installation
            setTimeout(() => {
                requestAppFullscreen();
            }, 1000);
        });

        // Check if app is already running in standalone mode (already installed)
        const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        if (isStandalone) {
            console.log('[PWA] App is running in standalone mode');
            installPromptElement.style.display = 'none';

            // Request fullscreen on app launch if already standalone/installed
            setTimeout(() => {
                requestAppFullscreen();
            }, 500);
        }
    </script>
</body>
</html>
